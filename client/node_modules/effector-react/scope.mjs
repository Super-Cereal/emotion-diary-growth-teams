function e(e,t,r,n){let u=[k.run({fn:e=>t(e)})];if(n&&u.unshift(n),r){let t=v({node:u}),n=e.graphite.id,o=r.additionalLinks,s=o[n]||[];return o[n]=s,s.push(t),()=>{let e=s.indexOf(t);-1!==e&&s.splice(e,1),g(t)}}{let t=v({node:u,parent:[e],family:{owners:e}});return()=>{g(t)}}}function t(e,t){return t.displayName=e,t}function r(t,r){S.store(t)||w('expect useStore argument to be a store');let n=y.useCallback((n=>e(t,n,r)),[t,r]),u=y.useCallback((()=>M(t,r)),[t,r]);return A(n,u,u)}function n([t,r],n){let u,o,s,a,l=R;r?(u=r,s=t,a=[]):({fn:u,store:s,keys:a,defaultValue:o,updateFilter:l=R}=t),S.store(s)||w('useStoreMap expects a store'),Array.isArray(a)||w('useStoreMap expects an array as keys'),'function'!=typeof u&&w('useStoreMap expects a function');let i=y.useCallback((t=>e(s,t,n)),[s,n]),c=y.useCallback((()=>M(s,n)),[s,n]),f=y.useRef(),d=y.useRef(),p=y.useRef(a);return E(i,c,c,(e=>{if(f.current!==e||!((e,t)=>{if(!e||!t||e.length!==t.length)return 0;let r=1;for(let n=0;n<e.length;n++)if(e[n]!==t[n]){r=0;break}return r})(p.current,a)){let t=u(e,a);void 0===t&&void 0!==o&&(t=o),f.current=e,p.current=a,void 0!==t&&(d.current=t)}return d.current}),((e,t)=>!l(t,e)))}function u(e,t){let r=t?e:e[0];var n;(e=>{if(!e)throw Error('expect first argument be an object')})(N(n=r)||(e=>'function'==typeof e)(n));let o=r.or,s=r.and;if(s){let r=t?s:s[0];if(N(r)&&'and'in r){let r=u(s,t);e=r[0],o={...o,...r[1]}}else e=s}return[e,o]}function o(e,t){let r=t&&N(n=t[0])&&(n.and||n.or)?t:[{and:t}];var n;let o,[[s,a],l]=u(r),i={},c={},f=l;var d;return'string'==typeof s?(c={name:s},N(d=a)&&'sid'in d||(i=a||{})):(e=>N(e)&&('domain'in e||'defaultState'in e||'name'in e))(s)&&(c=s,i=s.defaultState||{},o=s.domain),{hook:e,domain:o,defaultState:i,mainConfig:c,maybeConfig:f}}function s(e){let t=y.useContext(B);return e&&!t&&w('No scope found, consider adding <Provider> to app root'),t}function a(...e){return(({domain:e,defaultState:r,hook:n,mainConfig:u,maybeConfig:o})=>{function s(e){return n(s,e),null}let a=L({or:o,and:u}),l=`${e?`${e.compositeName.fullName}/`:''}${a.name||'gate'}`,i=j({name:`${l}.set`,sid:a.sid?`${a.sid}|set`:void 0}),c=j({name:`${l}.open`,sid:a.sid?`${a.sid}|open`:void 0}),f=j({name:`${l}.close`,sid:a.sid?`${a.sid}|close`:void 0}),d=C(Boolean(0),{name:`${l}.status`,serialize:'ignore'}).on(c,(()=>Boolean(1))).on(f,(()=>Boolean(0))),p=C(r,{name:`${l}.state`,sid:a.sid}).on(i,((e,t)=>t)).on(c,((e,t)=>t)).reset(f);if(e){let{hooks:t}=e;$({target:[t.store,t.store,t.event,t.event,t.event],params:[d,p,c,f,i]})}return s.open=c,s.close=f,s.status=d,s.state=p,s.set=i,t(`Gate:${l}`,s)})(o(l,e))}function l(e,t={}){let[r,n,u]=m([e.open,e.close,e.set]);((e,t={})=>{let r=y.useRef({value:null,count:0});O((()=>(e.open(r.current.value),()=>e.close(r.current.value))),[e]),((e,t)=>{if(e===t)return 1;if('object'==typeof e&&null!==e&&'object'==typeof t&&null!==t){let r=Object.keys(e),n=Object.keys(t);if(r.length!==n.length)return 0;for(let n=0;n<r.length;n++){let u=r[n];if(e[u]!==t[u])return 0}return 1}return 0})(r.current.value,t)||(r.current.value=t,r.current.count+=1),O((()=>{e.set(r.current.value)}),[r.current.count])})(y.useMemo((()=>({open:r,close:n,set:u})),[e,r]),t)}function i(e){return t=>{let r=c(e);return t.children(r)}}function c(e){return r(e,s(1))}function f(t){return((t,r)=>{let n=S.unit(t),u=n?{unit:t}:t,o=Array.isArray(u),s=y.useRef({stale:1,wasSubscribed:0,justSubscribed:0}),[a,l,i]=y.useMemo((()=>{s.current.stale=1;let e=Array.isArray(u)?[]:{},t=[],n=[];for(let o in u){let s=u[o];S.unit(s)||w('expect useUnit argument to be a unit'),S.event(s)||S.effect(s)?e[o]=r?x(s,{scope:r}):s:(e[o]=null,t.push(o),n.push(s))}return[e,t,n]}),[s,r,...Object.keys(u),...Object.values(u)]),c=y.useRef({value:a,storeKeys:l}),f=y.useCallback((t=>{let n=s.current;n.wasSubscribed&&(n.justSubscribed=1);let u=()=>{n.stale||(n.stale=1,t())},o=k.compute({priority:'sampler',batch:1}),a=i.map((t=>e(t,u,r,o)));return n.wasSubscribed=1,()=>{a.forEach((e=>e()))}}),[i,r,c,s]),d=y.useCallback((()=>{let e,t=c.current,u=s.current,f=0,d=t.value,p=t.storeKeys;if((l.length>0||p.length>0)&&(u.stale||u.justSubscribed)){f=!u.justSubscribed,e=o?[...a]:{...a},p.length!==l.length&&(f=1);for(let t=0;t<l.length;t++){let n=M(i[t],r),u=l[t];f||(f=p.includes(u)?d[u]!==n:1),e[u]=n}}return f&&(t.value=e),t.storeKeys=l,u.stale=0,u.justSubscribed=!f,n?t.value.unit:t.value}),[f,s]);return A(f,d,d)})(t,s(1))}function d(e,u){return((e,u,o)=>{let s,a,l,i=[];'object'==typeof u&&null!==u?(u.keys&&(i=u.keys),({fn:s,getKey:a,placeholder:l}=u)):s=u,S.store(e)||w('expect useList first argument to be a store'),'function'!=typeof s&&w("expect useList's renderItem to be a function"),Array.isArray(i)||w("expect useList's keys to be an array");let c=y.useMemo((()=>{let r=t(`${e.shortName||'Unknown'}.Item`,(t=>{let{index:r,keys:u,keyVal:s,value:a}=t;if(f.current[1])return f.current[0](a,s);let l=n([{store:e,keys:[r,...u],fn:(e,t)=>e[t[0]]}],o);return f.current[0](l,r)}));return y.memo(r)}),[e,o,!!a]),f=y.useRef([s,a]);f.current=[s,a];let d=y.useMemo((()=>i),i);if(a){let t=r(e,o);return 0===t.length&&l?l:t.map((e=>{let t=f.current[1](e);return y.createElement(c,{keyVal:t,key:t,keys:d,value:e})}))}{let t=n([{store:e,keys:[e],fn:e=>e.length}],o);return 0===t&&l?l:Array.from({length:t},((e,t)=>y.createElement(c,{index:t,key:t,keys:d})))}})(e,u,s(1))}function p(e,t){let r=s(1);return n(t?[e,t]:[{store:e.store,keys:e.keys,fn:e.fn,updateFilter:e.updateFilter}],r)}function m(e){return((e,t)=>{if(!t)return e;let r=S.unit(e)||'object'!=typeof e?{event:e}:e;return y.useMemo((()=>{if(S.unit(e))return x(e,{scope:t});let r=Array.isArray(e)?[]:{};for(let n in e)r[n]=x(e[n],{scope:t});return r}),[t,...Object.keys(r),...Object.values(r)])})(e,s(1))}import y from'react';import b from'use-sync-external-store/shim/with-selector.js';import h from'use-sync-external-store/shim/index.js';import{step as k,createNode as v,clearNode as g,is as S,scopeBind as x,createEvent as j,createStore as C,launch as $}from'effector/effector.mjs';let w=e=>{throw Error(e)};const{useSyncExternalStore:A}=h,{useSyncExternalStoreWithSelector:E}=b,M=(e,t)=>t?t.getState(e):e.getState(),R=(e,t)=>e!==t;let O='undefined'!=typeof window?y.useLayoutEffect:y.useEffect,N=e=>'object'==typeof e&&null!==e,L=(e,t={})=>(N(e)&&(L(e.or,t),(e=>{for(let u in e)n=u,(e=>void 0===e)(r=e[u])||'or'===n||'and'===n||(t[n]=r);var r,n})(e),L(e.and,t)),t),K=e=>console.error(`${e} is deprecated`);const B=y.createContext(null);let{Provider:F}=B,U=(e,t,r)=>(K('createContextComponent'),n=>{let u=y.useContext(t),o=c(e);return r(n,o,u)}),V=()=>w('not implemented'),G=(e,t)=>(K('createReactState'),I(t)(e)),I=e=>r=>{let n=e;return'function'!=typeof e&&(n=r,r=e),t(`Connect(${n.displayName||n.name||'Unknown'})`,(e=>y.createElement(n,{...e,...c(r)})))};export{F as Provider,I as connect,V as createComponent,U as createContextComponent,a as createGate,G as createReactState,i as createStoreConsumer,m as useEvent,l as useGate,d as useList,c as useStore,p as useStoreMap,f as useUnit};
//# sourceMappingURL=scope.mjs.map
